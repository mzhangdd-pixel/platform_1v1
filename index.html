<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âèå‰∫∫Âπ≥Âè∞‰π±Êñó (Dual Platformer Brawl)</title>
    <style>
        :root {
            --apple-blue: #0071e3;
            --apple-text: #1d1d1f;
            --apple-gray: #86868b;
            --apple-bg: #fbfbfd;
            --apple-card-bg: #ffffff;
            --apple-border: #d2d2d7;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--apple-bg);
            color: var(--apple-text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 18px;
            overflow: hidden;
            background: #fff;
        }

        canvas {
            background-color: #ffffff;
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .player-hud {
            width: 300px;
            padding: 10px;
            color: var(--apple-text);
        }

        .bar-container {
            width: 100%;
            height: 8px;
            background: #e5e5ea;
            margin-top: 8px;
            position: relative;
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            border-radius: 4px;
        }

        .hp-fill { background-color: #ff3b30; }
        .resource-fill { background-color: #007aff; }

        .cd-icons {
            display: flex;
            margin-top: 10px;
            gap: 8px;
        }

        .cd-box {
            width: 32px;
            height: 32px;
            background: #f2f2f7;
            border: 1px solid #e5e5ea;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--apple-text);
            position: relative;
            overflow: hidden;
        }

        .cd-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            transition: height 0.1s;
        }

        /* Apple Style Start Screen */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            pointer-events: auto;
            transition: opacity 0.5s;
        }

        #start-screen h1 {
            font-size: 48px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 10px;
            color: #1d1d1f;
        }

        #start-screen p {
            font-size: 17px;
            color: var(--apple-gray);
            margin-bottom: 40px;
        }

        .char-select-container {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }

        .char-card {
            width: 130px;
            height: 190px;
            border: 1px solid var(--apple-border);
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: var(--apple-card-bg);
            text-align: center;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }

        .char-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
            border-color: #86868b;
        }

        .char-icon { font-size: 48px; margin-bottom: 10px; }
        
        .char-card h3 { 
            margin: 5px 0; 
            font-size: 16px; 
            font-weight: 600; 
            color: #1d1d1f !important; 
        }

        .char-desc {
            font-size: 11px;
            color: var(--apple-gray);
            margin-top: 5px;
            line-height: 1.4;
        }

        /* Selection States */
        .char-card.selected-p1 { 
            border: 2px solid #ff3b30; 
            background-color: #fff0f0;
        }
        .char-card.selected-p2 { 
            border: 2px solid #007aff; 
            background-color: #f0f8ff;
        }
        .char-card.selected-both { 
            border: 2px solid #af52de; 
            background-color: #faf0ff;
        }

        button#start-btn {
            margin-top: 20px;
            padding: 12px 40px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            display: none;
            background-color: var(--apple-blue);
            color: white;
            border: none;
            border-radius: 980px; /* Pill shape */
            transition: background-color 0.2s;
        }

        button#start-btn:hover {
            background-color: #0077ED;
        }

        .instructions { 
            font-size: 13px; 
            color: var(--apple-gray); 
            margin-top: 40px; 
            text-align: center;
            background: #f5f5f7;
            padding: 20px;
            border-radius: 12px;
        }
        
        .instructions table th { color: var(--apple-text); font-weight: 600; }
        
        .key-hint { color: #eebb00; font-weight: bold; }
        
        /* In-game text tweaks */
        #p1-name { color: #ff3b30 !important; font-size: 16px; }
        #p2-name { color: #007aff !important; font-size: 16px; }
        
        /* VS Timer styling */
        #center-hud {
            text-align:center; 
            margin-top:10px; 
            font-size: 28px; 
            font-weight: 800; 
            color: #1d1d1f;
        }
        #game-timer {
            font-size: 14px; 
            color: var(--apple-gray); 
            font-weight: 400;
            margin-top: 5px;
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="1000" height="700"></canvas>
    
    <div id="ui-layer">
        <div class="player-hud" id="p1-hud">
            <div id="p1-name">P1: Êú™ÈÄâÊã©</div>
            <div style="font-size:13px; color:#86868b; margin-top:4px;">ÁîüÂëΩ: <span id="p1-lives" style="color:#1d1d1f; font-weight:600">3</span> | Ë°ÄÈáè: <span id="p1-hp-text" style="color:#1d1d1f; font-weight:600">0</span></div>
            <div class="bar-container"><div id="p1-hp-bar" class="bar-fill hp-fill" style="width: 100%;"></div></div>
            <div class="bar-container"><div id="p1-res-bar" class="bar-fill resource-fill" style="width: 100%;"></div></div>
            <div class="cd-icons">
                <div class="cd-box">X<div id="p1-cd-atk" class="cd-overlay" style="height:0%"></div></div>
                <div class="cd-box">C<div id="p1-cd-skill" class="cd-overlay" style="height:0%"></div></div>
                <div class="cd-box">V<div id="p1-cd-ult" class="cd-overlay" style="height:0%"></div></div>
                <div class="cd-box">F<div id="p1-cd-swap" class="cd-overlay" style="height:0%"></div></div>
            </div>
        </div>
        
        <div id="center-hud">
            VS
            <div id="game-timer">00:00</div>
        </div>

        <div class="player-hud" id="p2-hud" style="text-align: right;">
            <div id="p2-name">P2: Êú™ÈÄâÊã©</div>
            <div style="font-size:13px; color:#86868b; margin-top:4px;">Ë°ÄÈáè: <span id="p2-hp-text" style="color:#1d1d1f; font-weight:600">0</span> | ÁîüÂëΩ: <span id="p2-lives" style="color:#1d1d1f; font-weight:600">3</span></div>
            <div class="bar-container"><div id="p2-hp-bar" class="bar-fill hp-fill" style="width: 100%; float:right;"></div></div>
            <div class="bar-container"><div id="p2-res-bar" class="bar-fill resource-fill" style="width: 100%; float:right;"></div></div>
            <div class="cd-icons" style="justify-content: flex-end;">
                <div class="cd-box">,<div id="p2-cd-atk" class="cd-overlay" style="height:0%"></div></div>
                <div class="cd-box">.<div id="p2-cd-skill" class="cd-overlay" style="height:0%"></div></div>
                <div class="cd-box">/<div id="p2-cd-ult" class="cd-overlay" style="height:0%"></div></div>
                <div class="cd-box">;<div id="p2-cd-swap" class="cd-overlay" style="height:0%"></div></div>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1>Choose Your Fighter</h1>
        <p>P1 (Left Click) &nbsp;|&nbsp; P2 (Right Click)</p>
        <div class="char-select-container" id="char-selection">
            <!-- JS will populate this -->
        </div>
        <button id="start-btn">ÂºÄÂßãÂØπÊàò</button>
        <div class="instructions">
            <p style="margin-bottom: 10px; font-weight:600; color:#1d1d1f;">Ê∏∏ÊàèÁõÆÊ†áÔºöËÄóÂ∞ΩÂØπÊâã 3 Êù°ÂëΩ</p>
            <table style="margin:0 auto; font-size:12px; text-align:left; border-spacing: 15px 5px;">
                <tr><th>Âä®‰Ωú</th><th style="color:#ff3b30">Player 1</th><th style="color:#007aff">Player 2</th></tr>
                <tr><td>ÁßªÂä®</td><td>W A S D</td><td>I J K L</td></tr>
                <tr><td>‰∏ãÂè∞</td><td>S (Âú®Âè∞‰∏ä)</td><td>K (Âú®Âè∞‰∏ä)</td></tr>
                <tr><td>ÊîªÂáª</td><td>X</td><td>, (ÈÄóÂè∑)</td></tr>
                <tr><td>ÊäÄËÉΩ</td><td>C</td><td>. (Âè•Âè∑)</td></tr>
                <tr><td>Â§ßÊãõ</td><td>V</td><td>/ (ÊñúÊù†)</td></tr>
                <tr><td>Êç¢‰Ωç</td><td>F</td><td>; (ÂàÜÂè∑)</td></tr>
            </table>
        </div>
    </div>
</div>

<script>
/** * Ê∏∏ÊàèÂ∏∏ÈáèÈÖçÁΩÆ 
 */
const CANVAS_W = 1000;
const CANVAS_H = 700;
const FPS = 60;
const GRAVITY = 0.6;
const BASE_SPEED = 5;
const BASE_JUMP = -13.5; 
const SWAP_COOLDOWN = 600; 

// ËßíËâ≤ÂÆö‰πâ
const CHARACTERS = {
    mage: { 
        name: "Ê≥ïÂ∏à", icon: "üßô‚Äç‚ôÇÔ∏è", hp: 4, color: "#5ac8fa", resourceType: "mana", maxResource: 100, 
        desc: "ÊøÄÂÖâÁÇÆ / ÂõûÈ≠î",
        atkCost: 10, atkDmg: 1, ultCost: 60
    },
    warrior: { 
        name: "ÊàòÂ£´", icon: "‚öîÔ∏è", hp: 6, color: "#ff3b30", resourceType: "rage", maxResource: 100, 
        desc: "ÂÜ≤Èîã / ÁãÇÊö¥",
        atkCost: 0, atkDmg: 1, skillCost: 30, ultCost: 80
    },
    tank: { 
        name: "Âù¶ÂÖã", icon: "üõ°Ô∏è", hp: 7, color: "#34c759", resourceType: "cooldown", maxResource: 100, 
        desc: "ÂáªÈÄÄ / Ê¶ÇÁéáÊ†ºÊå°",
        atkCost: 0, atkDmg: 1
    },
    marksman: { 
        name: "Â∞ÑÊâã", icon: "üî´", hp: 3, color: "#ffcc00", resourceType: "energy", maxResource: 100, 
        desc: "ÁøªÊªö / Èú∞Âºπ",
        atkCost: 5, atkDmg: 1, skillCost: 25, ultCost: 60
    },
    ghost: { 
        name: "ÂπΩÁÅµ", icon: "üëª", hp: 5, color: "#af52de", resourceType: "cooldown", maxResource: 100, 
        desc: "ÈöêË∫´ / Èí©Â≠ê",
        atkCost: 0, atkDmg: 1
    }
};

/**
 * ÂÖ®Â±ÄÂèòÈáè
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let gameLoopId;
let lastTime = 0;
let globalTime = 0; // In seconds

// ËæìÂÖ•Áä∂ÊÄÅ
const keys = {};

// Ê∏∏ÊàèÂØπË±°
let players = [];
let projectiles = [];
let particles = [];
let platforms = [];
let spikeState = { active: false, timer: 0 }; // 5s CD, 3s Active

// Ê∏∏ÊàèÁä∂ÊÄÅ
let gameState = 'menu'; 
let p1Char = null;
let p2Char = null;

/**
 * ÂàùÂßãÂåñ‰∏éÂú∞Âõæ
 */
function initMap() {
    platforms = [];
    // Level 1: Âú∞Èù¢ (Spikes)
    platforms.push({ x: 0, y: 650, w: 1000, h: 50, type: 'ground', level: 1 });
    // Level 2
    platforms.push({ x: 100, y: 500, w: 200, h: 20, type: 'platform', level: 2, effect: 'jump' });
    platforms.push({ x: 700, y: 500, w: 200, h: 20, type: 'platform', level: 2, effect: 'jump' });
    // Level 3
    platforms.push({ x: 0, y: 350, w: 150, h: 20, type: 'platform', level: 3, effect: 'slow' });
    platforms.push({ x: 850, y: 350, w: 150, h: 20, type: 'platform', level: 3, effect: 'slow' });
    // Level 4
    platforms.push({ x: 350, y: 200, w: 300, h: 20, type: 'platform', level: 4, effect: 'speed' });
}

/**
 * ËæìÂÖ•ÁõëÂê¨
 */
window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if (gameState === 'playing') handleSpecialInputs(e.key.toLowerCase(), true);
});
window.addEventListener('keyup', e => {
    keys[e.key.toLowerCase()] = false;
    if (gameState === 'playing') handleSpecialInputs(e.key.toLowerCase(), false);
});

// ËßíËâ≤ÈÄâÊã©ÈÄªËæë
const charContainer = document.getElementById('char-selection');
Object.keys(CHARACTERS).forEach(key => {
    const char = CHARACTERS[key];
    const div = document.createElement('div');
    div.className = 'char-card';
    div.innerHTML = `<div class="char-icon">${char.icon}</div><h3>${char.name}</h3><div class="char-desc">HP: ${char.hp}<br>${char.desc}</div>`;
    
    div.addEventListener('click', () => { p1Char = key; updateSelectionUI(); });
    div.addEventListener('contextmenu', (e) => { e.preventDefault(); p2Char = key; updateSelectionUI(); });
    
    div.dataset.char = key;
    charContainer.appendChild(div);
});

function updateSelectionUI() {
    document.querySelectorAll('.char-card').forEach(c => {
        c.className = 'char-card';
        const k = c.dataset.char;
        if (p1Char === k && p2Char === k) c.classList.add('selected-both');
        else if (p1Char === k) c.classList.add('selected-p1');
        else if (p2Char === k) c.classList.add('selected-p2');
    });
    if (p1Char && p2Char) document.getElementById('start-btn').style.display = 'block';
}

document.getElementById('start-btn').addEventListener('click', startGame);

/**
 * Á±ªÂÆö‰πâ
 */
class Player {
    constructor(id, charKey, x, y) {
        this.id = id;
        this.charKey = charKey;
        this.stats = CHARACTERS[charKey];
        
        // Physics
        this.x = x;
        this.y = y;
        this.w = 30;
        this.h = 50;
        this.vx = 0;
        this.vy = 0;
        this.grounded = false;
        this.platform = null; 
        
        // Status
        this.lives = 3;
        this.maxHp = this.stats.hp;
        this.hp = this.maxHp;
        this.dir = id === 1 ? 1 : -1; 
        
        // Resources
        this.resource = (this.stats.resourceType === 'mana' || this.stats.resourceType === 'energy') ? 100 : 0;
        if (this.stats.resourceType === 'cooldown') this.resource = 100; 
        
        // Cooldowns & States
        this.cdAtk = 0;
        this.cdSkill = 0;
        this.cdUlt = 0;
        this.cdSwap = 0;
        
        this.invuln = 0; 
        this.buffSpeed = false;
        this.buffJump = false;
        this.debuffSlow = false;
        this.invisible = false;
        this.charging = false; // Mage ult prep
        this.chargeTimer = 0;
        this.raging = 0; 
        this.stunned = 0;
        this.tankUlt = 0; 
        this.nextHitStun = false; 
        
        // Action States (Locked Movement)
        this.actionState = 'idle'; // idle, rolling, dashing
        this.actionTimer = 0;
        this.atkAnimTimer = 0; // For visual swing effect
        
        // Input Mapping
        if (id === 1) {
            this.keys = { l:'a', r:'d', u:'w', d:'s', atk:'x', skill:'c', ult:'v', swap:'f' };
        } else {
            this.keys = { l:'j', r:'l', u:'i', d:'k', atk:',', skill:'.', ult:'/', swap:';' };
        }
    }

    isLocked() {
        return this.stunned > 0 || this.charging || this.actionState !== 'idle';
    }

    update() {
        if (this.lives <= 0) return;

        // Timers
        if (this.invuln > 0) this.invuln--;
        if (this.cdAtk > 0) this.cdAtk--;
        if (this.cdSkill > 0) this.cdSkill--;
        if (this.cdUlt > 0) this.cdUlt--;
        if (this.cdSwap > 0) this.cdSwap--;
        if (this.stunned > 0) this.stunned--;
        if (this.atkAnimTimer > 0) this.atkAnimTimer--;
        
        // State Management
        if (this.actionState !== 'idle') {
            this.actionTimer--;
            
            // Marksman Rolling
            if (this.actionState === 'rolling') {
                this.invuln = 2; // Keep invincible
            }
            // Warrior Dashing (Push logic)
            else if (this.actionState === 'dashing') {
                let enemy = this.id === 1 ? players[1] : players[0];
                // Simple collision check for push
                if (Math.abs((enemy.y + enemy.h/2) - (this.y + this.h/2)) < 60 &&
                    Math.abs((enemy.x + enemy.w/2) - (this.x + this.w/2)) < 60) {
                    // Push enemy
                    enemy.x = this.x + (this.dir * (this.w + 5));
                    enemy.stunned = 2; // Stun while pushing
                }
            }

            if (this.actionTimer <= 0) {
                this.actionState = 'idle';
                this.vx = 0; // Stop dash/roll
            }
        }

        if (this.stunned > 0) {
            this.vx = 0;
            this.applyPhysics();
            return;
        }
        
        // Mage Charge
        if (this.charging) {
            this.vx = 0;
            this.chargeTimer--;
            if (Math.random() < 0.5) particles.push(new Particle(this.x + Math.random()*this.w, this.y + Math.random()*this.h, "#5ac8fa", 'aura'));
            if (this.chargeTimer <= 0) {
                this.charging = false;
                this.fireLaser();
            }
            if (keys[this.keys.l]) this.vx = -BASE_SPEED * 0.2;
            if (keys[this.keys.r]) this.vx = BASE_SPEED * 0.2;
            this.applyPhysics();
            return;
        }

        // Other updates
        if (this.raging > 0) {
             this.raging--;
             if (Math.random() < 0.3) particles.push(new Particle(this.x + Math.random()*this.w, this.y + Math.random()*this.h, "#ff3b30", 'aura'));
        }
        if (this.tankUlt > 0) this.tankUlt--;
        if (this.invisible) {
            this.invisibleTimer--;
            if (this.invisibleTimer <= 0) this.invisible = false;
        }
        if (this.charKey === 'marksman' && this.resource < 100 && globalTime % 12 === 0) {
            this.resource++;
        }

        // Movement (Only if not locked)
        if (!this.isLocked()) {
            let speed = BASE_SPEED;
            if (this.buffSpeed) speed *= 2;
            if (this.raging > 0) speed *= 2;
            if (this.debuffSlow) speed /= 2;
            
            this.vx = 0;
            if (keys[this.keys.l]) { this.vx = -speed; this.dir = -1; }
            if (keys[this.keys.r]) { this.vx = speed; this.dir = 1; }
            
            // Jump
            if (keys[this.keys.u] && this.grounded) {
                let jumpPower = BASE_JUMP;
                if (this.buffJump) jumpPower *= 1.5;
                this.vy = jumpPower;
                this.grounded = false;
                this.platform = null;
            }

            // Drop
            if (keys[this.keys.d] && this.grounded && this.platform && this.platform.type !== 'ground') {
                 this.y += 1;
                 this.grounded = false;
                 this.platform = null;
            }
        }

        this.applyPhysics();
        this.checkMapEffects();
        
        // Actions
        if (!this.isLocked()) {
            if (keys[this.keys.atk] && this.cdAtk <= 0) this.attack();
            if (keys[this.keys.skill] && this.cdSkill <= 0) this.useSkill();
            if (keys[this.keys.ult] && this.cdUlt <= 0) this.useUlt();
            if (keys[this.keys.swap] && this.cdSwap <= 0) this.useSwap();
        }
    }

    applyPhysics() {
        this.vy += GRAVITY;
        this.x += this.vx;
        this.y += this.vy;

        if (this.x < 0) this.x = 0;
        if (this.x + this.w > CANVAS_W) this.x = CANVAS_W - this.w;

        this.grounded = false;
        for (let p of platforms) {
            if (this.vy >= 0 && 
                this.y + this.h >= p.y && 
                this.y + this.h <= p.y + p.h + 10 && 
                this.x + this.w > p.x && 
                this.x < p.x + p.w) {
                
                this.y = p.y - this.h;
                this.vy = 0;
                this.grounded = true;
                this.platform = p;
            }
        }
    }

    checkMapEffects() {
        let onSpecialPlat = false;
        if (this.grounded && this.platform) {
            if (this.platform.level === 2) { this.buffJump = true; onSpecialPlat = true; }
            else if (this.platform.level === 3) { this.debuffSlow = true; onSpecialPlat = true; }
            else if (this.platform.level === 4) { this.buffSpeed = true; onSpecialPlat = true; }
        }
        if (!onSpecialPlat) {
            this.buffJump = false;
            this.debuffSlow = false;
            if (this.buffSpeed) { 
                this.buffSpeed = false;
                this.invuln = 60; 
                createPopup(this.x, this.y, "Speed Lost!", "#000");
                createPopup(this.x, this.y - 20, "Invincible!", "#ffcc00");
            }
        }
    }

    takeDamage(amount, type = 'normal') {
        if (this.lives <= 0) return;
        if (this.invuln > 0) return;
        
        if (this.tankUlt > 0 && Math.random() < 0.5) {
            createPopup(this.x, this.y, "Blocked!", "#34c759");
            for(let i=0;i<5;i++) particles.push(new Particle(this.x+this.w/2, this.y+this.h/2, "#34c759", 'spark'));
            return;
        }
        
        if (this.charKey === 'warrior' && this.resource < 100) {
            this.resource = Math.min(100, this.resource + 5);
        }

        this.hp -= amount;
        createPopup(this.x, this.y, `-${amount}`, "#ff3b30");
        for(let i=0; i<8; i++) particles.push(new Particle(this.x + this.w/2, this.y + this.h/2, "#ff3b30", 'splash'));
        
        if (this.hp <= 0) this.die();
        else this.invuln = 10;
    }

    die() {
        this.lives--;
        createPopup(this.x, this.y, "DEAD", "#ff3b30");
        for(let i=0; i<15; i++) particles.push(new Particle(this.x + this.w/2, this.y + this.h/2, this.stats.color, 'splash'));

        if (this.lives > 0) this.respawn();
        else endGame(this.id === 1 ? 2 : 1);
    }

    respawn() {
        if (this.id === 1) { this.x = 50; this.y = 200; }
        else { this.x = 920; this.y = 200; }
        this.hp = this.maxHp;
        this.vx = 0; this.vy = 0;
        this.invuln = 60;
        this.resource = (this.stats.resourceType === 'mana' || this.stats.resourceType === 'energy') ? 100 : 0;
        this.invisible = false;
        this.raging = 0;
        this.buffSpeed = false;
        this.actionState = 'idle';
    }

    attack() {
        if (this.invisible) this.invisible = false;
        if (this.charKey === 'mage' && this.resource < 10) return;
        if (this.charKey === 'marksman' && this.resource < 5) return;

        this.cdAtk = 30; 
        this.atkAnimTimer = 15; // Show visual for 0.25s

        let startX = this.dir === 1 ? this.x + this.w : this.x;
        let startY = this.y + this.h / 2;

        if (this.charKey === 'mage') {
            this.resource -= 10;
            projectiles.push(new Projectile(startX, startY, this.dir * 8, 0, this.id, 1, 'fireball'));
        } else if (this.charKey === 'marksman') {
            this.resource -= 5;
            projectiles.push(new Projectile(startX, startY, this.dir * 15, 0, this.id, 1, 'bullet'));
        } else if (this.charKey === 'warrior') {
            this.createMeleeHitbox(60, 1, 0);
            this.resource = Math.min(100, this.resource + 10);
        } else if (this.charKey === 'tank') {
            let hit = this.createMeleeHitbox(50, 1, 0);
            if (hit) {
                let enemy = this.id === 1 ? players[1] : players[0];
                enemy.vx = this.dir * 15;
                enemy.vy = -5;
                if (this.nextHitStun) {
                    enemy.stunned = 30;
                    createPopup(enemy.x, enemy.y, "Stun!", "#34c759");
                    this.nextHitStun = false;
                }
            }
        } else if (this.charKey === 'ghost') {
            this.createMeleeHitbox(50, 1, 0);
        }
    }

    createMeleeHitbox(range, dmg, stunTime) {
        let enemy = this.id === 1 ? players[1] : players[0];
        let dist = (enemy.x + enemy.w/2) - (this.x + this.w/2);
        if ((this.dir === 1 && dist > 0 && dist < range) || (this.dir === -1 && dist < 0 && Math.abs(dist) < range)) {
            if (Math.abs((enemy.y + enemy.h/2) - (this.y + this.h/2)) < 60) {
                enemy.takeDamage(dmg);
                if (stunTime > 0) enemy.stunned = stunTime;
                return true;
            }
        }
        return false;
    }

    useSkill() {
        if (this.invisible) this.invisible = false;

        if (this.charKey === 'mage') {
            this.cdSkill = 600; 
            this.resource = 100;
            createPopup(this.x, this.y, "Mana Full", "#5ac8fa");
            for(let i=0; i<8; i++) particles.push(new Particle(this.x + Math.random()*this.w, this.y + this.h, "#5ac8fa", 'aura'));
        }
        else if (this.charKey === 'warrior') {
            if (this.resource < 30) return;
            this.resource -= 30;
            this.cdSkill = 480; 
            
            // Charge logic
            this.actionState = 'dashing';
            this.actionTimer = 24; // Reduced to 2/5 distance approx (40 -> 24 frames)
            this.vx = this.dir * 8; // Slightly slower speed (12 -> 8)
            this.invuln = 10;
            
            for(let i=0; i<5; i++) particles.push(new Particle(this.x, this.y + Math.random()*this.h, "#aaa", 'dash'));
        }
        else if (this.charKey === 'tank') {
            this.cdSkill = 300; 
            this.nextHitStun = true;
            createPopup(this.x, this.y, "Stun Ready", "#34c759");
            for(let i=0; i<5; i++) particles.push(new Particle(this.x + Math.random()*this.w, this.y, "#34c759", 'spark'));
        }
        else if (this.charKey === 'marksman') {
            if (this.resource < 25) return;
            this.resource -= 25;
            this.cdSkill = 300; // Add Cooldown for roll
            
            // Roll logic
            this.actionState = 'rolling';
            this.actionTimer = 10; // Reduced to 1/3 distance (30 -> 10 frames)
            this.vx = this.dir * 15;
            this.invuln = 30; // Full duration invuln (0.5s) stays same
            
            createPopup(this.x, this.y-30, "Êó†Êïå!", "#ffcc00");
             for(let i=0; i<5; i++) particles.push(new Particle(this.x + this.w/2, this.y + this.h, "#8e8e93", 'splash'));
        }
        else if (this.charKey === 'ghost') {
            this.cdSkill = 600; 
            this.invisible = true;
            this.invisibleTimer = 180; 
            createPopup(this.x, this.y, "Invisible", "#af52de");
             for(let i=0; i<10; i++) particles.push(new Particle(this.x + Math.random()*this.w, this.y + Math.random()*this.h, "#af52de", 'splash'));
        }
    }

    useUlt() {
        if (this.invisible) this.invisible = false;

        if (this.charKey === 'mage') {
            if (this.resource < 60) return;
            this.resource -= 60;
            this.charging = true;
            this.chargeTimer = 120; 
        }
        else if (this.charKey === 'warrior') {
            if (this.resource < 80) return;
            this.resource -= 80;
            this.raging = 300; 
            createPopup(this.x, this.y, "RAGE!", "#ff3b30");
        }
        else if (this.charKey === 'tank') {
            this.cdUlt = 1080; 
            this.tankUlt = 180; 
            createPopup(this.x, this.y, "Guard Up", "#34c759");
        }
        else if (this.charKey === 'marksman') {
            if (this.resource < 60) return;
            this.resource -= 60;
            for(let i=0; i<20; i++) {
                 let angle = (Math.random() - 0.5) * 1; 
                 let speed = Math.random() * 5 + 2;
                 let p = new Particle(this.x+(this.dir===1?this.w:0), this.y+this.h/2, "#ff9500", 'spark');
                 p.vx = (this.dir * speed) + Math.cos(angle)*2;
                 p.vy = Math.sin(angle) * 2;
                 particles.push(p);
            }
            for(let i=-2; i<=2; i++) {
                let vy = i * 2;
                projectiles.push(new Projectile(this.x + (this.dir===1?this.w:0), this.y + this.h/2, this.dir * 12, vy, this.id, 1, 'bullet'));
            }
        }
        else if (this.charKey === 'ghost') {
            this.cdUlt = 1080; 
            projectiles.push(new Projectile(this.x, this.y + this.h/2, this.dir * 20, 0, this.id, 1, 'hook'));
        }
    }

    fireLaser() {
        let laserY = this.y + this.h/2;
        projectiles.push(new Projectile(0, laserY, 0, 0, this.id, 0, 'laser_beam'));
    }

    useSwap() {
        this.cdSwap = SWAP_COOLDOWN;
        let other = this.id === 1 ? players[1] : players[0];
        let tx = this.x; let ty = this.y;
        this.x = other.x; this.y = other.y;
        other.x = tx; other.y = ty;
        createPopup(this.x, this.y, "SWAP!", "#af52de");
        createPopup(other.x, other.y, "SWAP!", "#af52de");
    }

    draw(ctx) {
         if (this.lives <= 0) return;
         
         if (this.invisible) ctx.globalAlpha = 0.3;
         
         // Visuals - Warrior Rage
         if (this.raging > 0) {
             ctx.save();
             ctx.strokeStyle = `rgba(255, 59, 48, ${(this.raging % 20) / 20})`;
             ctx.lineWidth = 3;
             ctx.strokeRect(this.x-5, this.y-5, this.w+10, this.h+10);
             ctx.restore();
         }

         // Visuals - Tank Shield
         if (this.tankUlt > 0) {
             ctx.save();
             ctx.strokeStyle = "#34c759";
             ctx.lineWidth = 3;
             ctx.beginPath();
             ctx.arc(this.x+this.w/2, this.y+this.h/2, 40, 0, Math.PI*2);
             ctx.stroke();
             ctx.restore();
         }

         // Visuals - Melee Attack Swing
         if (this.atkAnimTimer > 0) {
            ctx.save();
            let cx = this.x + this.w/2;
            let cy = this.y + this.h/2;
            let range = 40;
            
            if (this.charKey === 'warrior') {
                // Sword Arc
                ctx.beginPath();
                let startAngle = this.dir === 1 ? -0.5 : Math.PI - 0.5;
                let endAngle = this.dir === 1 ? 0.5 : Math.PI + 0.5;
                ctx.arc(cx, cy, range + 10, startAngle, endAngle, false);
                ctx.strokeStyle = `rgba(255, 255, 255, ${this.atkAnimTimer/15})`;
                ctx.lineWidth = 8;
                ctx.stroke();
                // Red core
                ctx.strokeStyle = `rgba(255, 59, 48, ${this.atkAnimTimer/15})`;
                ctx.lineWidth = 4;
                ctx.stroke();
            } else if (this.charKey === 'tank') {
                // Shield Bash (Rectangle push)
                ctx.fillStyle = `rgba(52, 199, 89, ${this.atkAnimTimer/15})`;
                let bx = this.dir === 1 ? this.x + this.w : this.x - 40;
                ctx.fillRect(bx, this.y, 40, this.h);
            } else if (this.charKey === 'ghost') {
                // Claw scratches
                ctx.strokeStyle = `rgba(175, 82, 222, ${this.atkAnimTimer/15})`;
                ctx.lineWidth = 3;
                let offX = this.dir * 40;
                ctx.beginPath(); ctx.moveTo(cx, cy-10); ctx.lineTo(cx+offX, cy+10); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx+offX, cy+20); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx, cy+10); ctx.lineTo(cx+offX, cy+30); ctx.stroke();
            }
            ctx.restore();
         }

         // Base Player
         ctx.fillStyle = this.stats.color;
         if (this.invuln > 0 && Math.floor(Date.now()/50)%2===0) ctx.fillStyle = "#fff"; 
         ctx.fillRect(this.x, this.y, this.w, this.h);
         
         // Icon
         ctx.font = "30px Apple Color Emoji, Segoe UI Emoji";
         ctx.textAlign = "center";
         ctx.textBaseline = "middle";
         ctx.fillStyle = "#fff";
         ctx.fillText(this.stats.icon, this.x + this.w/2, this.y + this.h/2 + 2);

         // Mage Charge
         if (this.charging) {
             ctx.fillStyle = "#5ac8fa";
             ctx.fillRect(this.x, this.y - 10, this.w * (this.chargeTimer/120), 5);
         }

         ctx.globalAlpha = 1.0;
    }
}

class Projectile {
    constructor(x, y, vx, vy, ownerId, dmg, type) {
        this.x = x; this.y = y;
        this.vx = vx; this.vy = vy;
        this.ownerId = ownerId;
        this.dmg = dmg;
        this.type = type;
        this.active = true;
        this.w = (type === 'fireball') ? 15 : 8;
        this.h = (type === 'fireball') ? 15 : 8;
        
        if (type === 'hook') { this.w = 20; this.h = 10; }
        if (type === 'laser_beam') { 
            this.w = CANVAS_W; 
            this.h = 40; 
            this.x = 0;
            this.life = 180; 
            this.tickTimer = 0;
        }
    }

    update() {
        if (!this.active) return;

        if (this.type === 'laser_beam') {
            this.life--;
            if (this.life <= 0) this.active = false;
            if (Math.random() < 0.5) {
                let py = this.y + (Math.random()-0.5)*20;
                particles.push(new Particle(Math.random()*CANVAS_W, py, "#5ac8fa", 'spark'));
            }
            this.tickTimer++;
            if (this.tickTimer % 30 === 0) {
                let enemy = this.ownerId === 1 ? players[1] : players[0];
                if (Math.abs((enemy.y + enemy.h/2) - this.y) < this.h) {
                     enemy.takeDamage(1); 
                }
            }
            return;
        }

        this.x += this.vx;
        this.y += this.vy;

        if (this.x < -50 || this.x > CANVAS_W + 50) this.active = false;

        let enemy = this.ownerId === 1 ? players[1] : players[0];
        if (this.x < enemy.x + enemy.w &&
            this.x + this.w > enemy.x &&
            this.y < enemy.y + enemy.h &&
            this.y + this.h > enemy.y) {
            
            if (this.type === 'hook') {
                enemy.x = players[this.ownerId-1].x + (players[this.ownerId-1].dir * 40);
                enemy.y = players[this.ownerId-1].y;
                enemy.stunned = 10;
                enemy.takeDamage(this.dmg);
            } else {
                enemy.takeDamage(this.dmg);
            }
            this.active = false;
        }
    }

    draw(ctx) {
        if (!this.active) return;
        
        if (this.type === 'laser_beam') {
            ctx.fillStyle = `rgba(90, 200, 250, ${this.life/180 * 0.5})`;
            ctx.fillRect(0, this.y - this.h/2, CANVAS_W, this.h);
            return;
        }
        
        if (this.type === 'hook') {
            let owner = players[this.ownerId - 1];
            ctx.strokeStyle = "#8e8e93";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(owner.x + owner.w/2, owner.y + owner.h/2);
            ctx.lineTo(this.x, this.y);
            ctx.stroke();
            ctx.fillStyle = "#af52de";
        } else {
            ctx.fillStyle = this.ownerId === 1 ? '#ff3b30' : '#007aff';
        }
        
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.w/2, 0, Math.PI*2);
        ctx.fill();
    }
}

class Particle {
    constructor(x, y, color, type = 'normal') {
        this.x = x; this.y = y;
        this.type = type;
        this.color = color;
        
        if (type === 'splash') {
            this.vx = (Math.random() - 0.5) * 8;
            this.vy = (Math.random() - 0.5) * 8;
            this.life = 20;
            this.size = Math.random() * 4 + 2;
        } else if (type === 'spark') {
            this.vx = (Math.random() - 0.5) * 3;
            this.vy = (Math.random() - 0.5) * 3;
            this.life = 15;
            this.size = 2;
        } else if (type === 'aura') {
            this.vx = 0;
            this.vy = -2;
            this.life = 20;
            this.size = 3;
        } else if (type === 'dash') {
            this.vx = -2; 
            this.vy = 0;
            this.life = 10;
            this.size = 2;
        } else {
            this.vx = (Math.random() - 0.5) * 5;
            this.vy = (Math.random() - 0.5) * 5;
            this.life = 30;
            this.size = 4;
        }
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.life--;
    }
    draw(ctx) {
        ctx.fillStyle = this.color;
        ctx.globalAlpha = this.life / (this.type === 'splash' ? 20 : 30);
        ctx.fillRect(this.x, this.y, this.size, this.size);
        ctx.globalAlpha = 1;
    }
}

let popups = [];
function createPopup(x, y, text, color) {
    popups.push({x, y, text, color, life: 40});
}

function startGame() {
    if (!p1Char || !p2Char) return;
    const startScreen = document.getElementById('start-screen');
    startScreen.style.opacity = '0';
    setTimeout(() => { startScreen.style.display = 'none'; }, 500);
    initMap();
    players = [ new Player(1, p1Char, 100, 200), new Player(2, p2Char, 900, 200) ];
    gameState = 'playing';
    spikeState = { active: false, timer: 0 };
    document.getElementById('p1-name').innerText = `P1: ${CHARACTERS[p1Char].icon} ${CHARACTERS[p1Char].name}`;
    document.getElementById('p2-name').innerText = `P2: ${CHARACTERS[p2Char].icon} ${CHARACTERS[p2Char].name}`;
    gameLoop();
}

function handleSpecialInputs(key, isDown) {}

function endGame(winnerId) {
    gameState = 'gameover';
    cancelAnimationFrame(gameLoopId);
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.fillRect(0,0, CANVAS_W, CANVAS_H);
    ctx.fillStyle = "#1d1d1f";
    ctx.font = "bold 60px -apple-system, BlinkMacSystemFont, sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(`Áé©ÂÆ∂ ${winnerId} Ëé∑ËÉú!`, CANVAS_W/2, CANVAS_H/2);
    setTimeout(() => { location.reload(); }, 3000);
}

function gameLoop(timestamp) {
    if (gameState !== 'playing') return;
    let deltaTime = timestamp - lastTime;
    lastTime = timestamp;
    spikeState.timer++;
    let cycle = spikeState.timer % 300; 
    spikeState.active = cycle < 180; 
    if (spikeState.timer % 60 === 0) globalTime++;

    ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);

    platforms.forEach(p => {
        if (p.level === 1) ctx.fillStyle = spikeState.active ? "#ff3b30" : "#1d1d1f";
        else if (p.level === 2) ctx.fillStyle = "#4cd964";
        else if (p.level === 3) ctx.fillStyle = "#ff9500";
        else if (p.level === 4) ctx.fillStyle = "#007aff";
        ctx.beginPath(); ctx.roundRect(p.x, p.y, p.w, p.h, 5); ctx.fill();
        
        if (p.level === 1 && spikeState.active) {
            ctx.fillStyle = "#ff3b30";
            for(let i=p.x; i<p.x+p.w; i+=20) {
                ctx.beginPath(); ctx.moveTo(i, p.y); ctx.lineTo(i+10, p.y-15); ctx.lineTo(i+20, p.y); ctx.fill();
            }
            players.forEach(pl => {
                if (pl.grounded && pl.platform === p) {
                    if (spikeState.timer % 60 === 0) pl.takeDamage(1, 'spike');
                }
            });
        }
    });
    
    ctx.fillStyle = "#86868b";
    ctx.font = "12px -apple-system, BlinkMacSystemFont, sans-serif";
    ctx.fillText("Level 2: Jump x1.5", 150, 525);
    ctx.fillText("Level 3: Slow", 50, 375);
    ctx.fillText("Level 4: Speed x2", 450, 225);

    players.forEach(p => { p.update(); p.draw(ctx); });
    projectiles = projectiles.filter(p => p.active);
    projectiles.forEach(p => { p.update(); p.draw(ctx); });
    particles = particles.filter(p => p.life > 0);
    particles.forEach(p => { p.update(); p.draw(ctx); });
    popups = popups.filter(p => p.life > 0);
    popups.forEach(p => {
        p.life--; p.y -= 0.5;
        ctx.fillStyle = p.color;
        ctx.font = "bold 16px -apple-system, BlinkMacSystemFont, sans-serif";
        ctx.fillText(p.text, p.x, p.y);
    });

    updateHUD();
    gameLoopId = requestAnimationFrame(gameLoop);
}

function updateHUD() {
    document.getElementById('game-timer').innerText = `Time: ${Math.floor(globalTime / 60)}:${(globalTime % 60).toString().padStart(2,'0')}`;
    players.forEach((p, i) => {
        let id = i + 1;
        document.getElementById(`p${id}-hp-text`).innerText = p.hp;
        document.getElementById(`p${id}-lives`).innerText = p.lives;
        let hpPct = (p.hp / p.maxHp) * 100;
        document.getElementById(`p${id}-hp-bar`).style.width = `${Math.max(0, hpPct)}%`;
        let resPct = (p.resource / 100) * 100; 
        document.getElementById(`p${id}-res-bar`).style.width = `${resPct}%`;
        setCD(`p${id}-cd-atk`, p.cdAtk, 30);
        setCD(`p${id}-cd-skill`, p.cdSkill, 600); 
        setCD(`p${id}-cd-ult`, p.cdUlt, 1080);
        setCD(`p${id}-cd-swap`, p.cdSwap, 600);
    });
}

function setCD(elId, current, max) {
    let pct = Math.min(100, (current / (max || 100)) * 100);
    document.getElementById(elId).style.height = `${pct}%`;
}

initMap();
</script>
<!-- Gamepad Support --><script src="gamepad-handler.js"></script><script src="gamepad-integration.js"></script>
</body>
</html>